<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>사운드보드 (다중 업로드 + 동시 재생)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; padding:18px; background:#f7f8fb; color:#111 }
  h1 { margin:0 0 12px; font-size:20px }
  #controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
  input[type=file] { padding:6px 8px }
  #buttons { display:flex; flex-wrap:wrap; gap:10px }
  .item { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .play { background:#2563eb; color:white; border:0; padding:10px 14px; border-radius:8px; min-width:120px; cursor:pointer }
  .play.playing { background:#16a34a }
  .del { background:#ef4444; color:white; border:0; padding:6px 8px; border-radius:6px; cursor:pointer }
  #status { margin-top:12px; color:#555; font-size:13px }
  .small { font-size:12px; color:#666 }
</style>
</head>
<body>
  <h1>공연용 사운드보드 (동시 재생 가능)</h1>

  <div id="controls">
    <label>
      파일 선택
      <input id="fileInput" type="file" accept="audio/*" multiple>
    </label>
    <label class="small">볼륨
      <input id="volume" type="range" min="0" max="1" step="0.01" value="1">
    </label>
    <label class="small"><input id="loop" type="checkbox"> 반복</label>
    <button id="clearAll" class="del">모두 삭제</button>
  </div>

  <div id="buttons"></div>

  <div id="status">로딩 중...</div>
  <p class="small">키보드 단축키: 1,2,3… (첫 9개)</p>

<script>
(async function(){
  const fileInput = document.getElementById('fileInput');
  const buttonsDiv = document.getElementById('buttons');
  const status = document.getElementById('status');
  const volumeCtrl = document.getElementById('volume');
  const loopCtrl = document.getElementById('loop');
  const clearAllBtn = document.getElementById('clearAll');

  // IndexedDB 유틸
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('soundboard-db', 2);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('files')) {
          db.createObjectStore('files', { keyPath: 'name' });
        }
      };
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
  }
  async function putFile(file) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('files','readwrite');
      const store = tx.objectStore('files');
      const obj = { name: file.name, blob: file, time: Date.now() };
      const r = store.put(obj);
      r.onsuccess = () => res();
      r.onerror = (e) => rej(e.target.error);
    });
  }
  async function getAllFiles() {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('files','readonly');
      const store = tx.objectStore('files');
      const req = store.getAll();
      req.onsuccess = () => res(req.result || []);
      req.onerror = (e) => rej(e.target.error);
    });
  }
  async function deleteFile(name) {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('files','readwrite');
      const store = tx.objectStore('files');
      const r = store.delete(name);
      r.onsuccess = () => res();
      r.onerror = (e) => rej(e.target.error);
    });
  }
  async function clearAllFiles() {
    const db = await openDB();
    return new Promise((res, rej) => {
      const tx = db.transaction('files','readwrite');
      const store = tx.objectStore('files');
      const r = store.clear();
      r.onsuccess = () => res();
      r.onerror = (e) => rej(e.target.error);
    });
  }

  // 상태
  let list = [];
  let playingMap = {}; // name → Audio 객체

  function setStatus(msg) { status.textContent = msg; }
  function revokeAllURLs() {
    list.forEach(item => { try { URL.revokeObjectURL(item.url); } catch(_){} });
  }

  // UI
  function render() {
    buttonsDiv.innerHTML = '';
    list.forEach((item, idx) => {
      const wrap = document.createElement('div');
      wrap.className = 'item';

      const btn = document.createElement('button');
      btn.className = 'play' + (playingMap[item.name] ? ' playing' : '');
      btn.textContent = `${idx+1}. ${item.name.replace(/\.[^/.]+$/,'')}`;
      btn.onclick = () => togglePlay(item);

      const del = document.createElement('button');
      del.className = 'del';
      del.textContent = '삭제';
      del.onclick = async () => {
        stopSound(item.name);
        await deleteFile(item.name);
        list = list.filter(it => it.name !== item.name);
        render();
        setStatus(`삭제: ${item.name}`);
      };

      wrap.appendChild(btn);
      wrap.appendChild(del);
      buttonsDiv.appendChild(wrap);
    });
    setStatus(`파일 ${list.length}개 로드됨`);
  }

  // 재생/정지
  function togglePlay(item) {
    if (playingMap[item.name]) {
      stopSound(item.name);
    } else {
      const audio = new Audio(item.url);
      audio.volume = parseFloat(volumeCtrl.value);
      audio.loop = !!loopCtrl.checked;
      audio.onended = () => {
        if (!audio.loop) {
          delete playingMap[item.name];
          render();
        }
      };
      audio.play().catch(err => setStatus('재생 오류: ' + err.message));
      playingMap[item.name] = audio;
      render();
      setStatus(`재생: ${item.name}`);
    }
  }
  function stopSound(name) {
    if (playingMap[name]) {
      playingMap[name].pause();
      playingMap[name].currentTime = 0;
      delete playingMap[name];
      render();
      setStatus(`정지: ${name}`);
    }
  }

  // 업로드
  fileInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    setStatus('업로드 중...');
    for (const f of files) await putFile(f);
    await loadFromDB();
    setStatus(`업로드 완료 (${files.length}개)`);
    fileInput.value = '';
  });

  // DB 로드
  async function loadFromDB() {
    revokeAllURLs();
    list = [];
    const rows = await getAllFiles();
    rows.sort((a,b) => a.time - b.time);
    for (const r of rows) {
      const url = URL.createObjectURL(r.blob);
      list.push({ name: r.name, url });
    }
    render();
  }

  // 모두 삭제
  clearAllBtn.addEventListener('click', async () => {
    if (!confirm('모든 파일을 삭제할까요?')) return;
    await clearAllFiles();
    revokeAllURLs();
    list = [];
    playingMap = {};
    render();
    setStatus('모두 삭제됨');
  });

  // 볼륨/루프
  volumeCtrl.addEventListener('input', () => {
    Object.values(playingMap).forEach(a => a.volume = volumeCtrl.value);
    localStorage.setItem('sb-volume', volumeCtrl.value);
  });
  loopCtrl.addEventListener('change', () => {
    Object.values(playingMap).forEach(a => a.loop = !!loopCtrl.checked);
    localStorage.setItem('sb-loop', loopCtrl.checked ? '1':'0');
  });

  // 단축키
  document.addEventListener('keydown', (ev) => {
    if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
    if (/^[1-9]$/.test(ev.key)) {
      const idx = parseInt(ev.key,10)-1;
      if (idx < list.length) togglePlay(list[idx]);
    }
  });

  // 초기화
  const sv = localStorage.getItem('sb-volume');
  if (sv) volumeCtrl.value = sv;
  const sl = localStorage.getItem('sb-loop');
  if (sl) loopCtrl.checked = (sl==='1');
  await loadFromDB();
})();
</script>
</body>
</html>




